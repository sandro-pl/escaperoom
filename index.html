<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room: O Mist√©rio do Diploma Desaparecido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
        }
        .mono {
            font-family: 'Roboto Mono', monospace;
        }
        .room-bg {
            background: url('https://eventos.sp.senac.br/wp-content/uploads/2021/11/fachada-senac-araraquara-nova-1920x700.jpeg') no-repeat center center;
            background-size: cover;
        }
        .interactive-object {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border-radius: 12px;
        }
        .interactive-object:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.7);
        }
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .input-code {
            width: 50px;
            height: 60px;
            font-size: 2rem;
        }
        .regimento-content {
            max-height: 60vh;
            overflow-y: auto;
            text-align: left;
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
        }
        .jigsaw-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            width: 300px;
            height: 300px;
            margin: auto;
            border: 2px solid #ccc;
        }
        .jigsaw-piece {
            background-image: url('https://cdn-icons-png.flaticon.com/512/149/149336.png');
            background-size: 300% 300%;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .jigsaw-piece.selected {
            transform: scale(1.1);
            box-shadow: 0 0 15px #f08324;
            opacity: 0.8;
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Tela Inicial -->
    <div id="start-screen" class="h-screen w-screen flex flex-col items-center justify-center p-4 bg-gray-800 text-center">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/86/Senac_logo.svg/1200px-Senac_logo.svg.png" alt="Logo Senac" class="h-16 mx-auto mb-8">
        <h1 class="text-4xl md:text-5xl font-bold text-orange-500 mb-4">O Mist√©rio do Diploma Desaparecido</h1>
        <p class="max-w-2xl text-lg text-gray-300 mb-8">
            Voc√™ est√° a minutos da formatura, mas seu diploma sumiu! Um instrutor o trancou nesta sala para um teste final. Voc√™ tem <strong>15 minutos</strong> para provar que conhece o Regimento Educacional e encontrar seu diploma.
        </p>
        <button id="start-button" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition-transform duration-200 transform hover:scale-105">Come√ßar o Desafio</button>
        <p class="mt-4 text-sm text-gray-500">Desenvolvimento: Sandro Polizel</p>
    </div>

    <!-- Tela do Jogo -->
    <div id="game-screen" class="h-screen w-screen hidden flex-col">
        <header class="w-full bg-black bg-opacity-50 p-4 flex justify-between items-center">
            <h2 class="text-2xl font-bold text-orange-500">Escape Room Senac</h2>
            <div id="timer" class="mono text-4xl font-bold bg-red-600 px-4 py-1 rounded-lg">15:00</div>
        </header>

        <main class="flex-grow room-bg relative p-8">
            <div class="absolute inset-0 bg-black bg-opacity-40"></div>
            <div id="message-display" class="absolute top-20 left-1/2 -translate-x-1/2 text-gray-900 p-4 rounded-lg shadow-2xl opacity-0 transition-opacity duration-500 z-[100] font-semibold border-2 border-orange-500" style="background-color: white;"></div>
            
            <div class="relative z-10 grid grid-cols-4 grid-rows-2 h-full gap-8">
                <!-- Objetos Interativos -->
                <div id="obj-drawer" class="interactive-object bg-black bg-opacity-60 flex flex-col items-center justify-center p-4">
                    <span class="text-6xl">üóÑÔ∏è</span>
                    <h3 class="text-xl font-semibold mt-2">Gaveta Trancada</h3>
                </div>
                <div id="obj-computer" class="interactive-object bg-black bg-opacity-60 flex flex-col items-center justify-center p-4 opacity-50 cursor-not-allowed">
                    <span class="text-6xl">üíª</span>
                    <h3 class="text-xl font-semibold mt-2">Computador</h3>
                </div>
                <div id="obj-panel" class="interactive-object bg-black bg-opacity-60 flex flex-col items-center justify-center p-4 opacity-50 cursor-not-allowed">
                    <span class="text-6xl">‚ö°</span>
                    <h3 class="text-xl font-semibold mt-2">Painel El√©trico</h3>
                </div>
                <div id="obj-book" class="interactive-object bg-black bg-opacity-60 flex flex-col items-center justify-center p-4">
                    <span class="text-6xl">üìñ</span>
                    <h3 class="text-xl font-semibold mt-2">Regimento</h3>
                </div>
                <div id="obj-recorder" class="interactive-object bg-black bg-opacity-60 flex flex-col items-center justify-center p-4 opacity-50 cursor-not-allowed">
                    <span class="text-6xl">üé§</span>
                    <h3 class="text-xl font-semibold mt-2">Gravador Antigo</h3>
                </div>
                <div id="obj-safe" class="interactive-object bg-black bg-opacity-60 flex flex-col items-center justify-center p-4 opacity-50 cursor-not-allowed">
                     <span class="text-6xl">üì¶</span>
                    <h3 class="text-xl font-semibold mt-2">Cofre Final</h3>
                </div>
                <!-- NOVOS OBJETOS -->
                <div id="obj-calendar" class="interactive-object bg-black bg-opacity-60 flex flex-col items-center justify-center p-4">
                     <span class="text-6xl">üìÖ</span>
                    <h3 class="text-xl font-semibold mt-2">Calend√°rio</h3>
                </div>
                <div id="obj-board" class="interactive-object bg-black bg-opacity-60 flex flex-col items-center justify-center p-4">
                     <span class="text-6xl">üìå</span>
                    <h3 class="text-xl font-semibold mt-2">Quadro de Avisos</h3>
                </div>
            </div>
        </main>
    </div>

    <!-- Tela de Vit√≥ria/Derrota -->
    <div id="end-screen" class="hidden h-screen w-screen flex-col items-center justify-center p-4 text-center bg-gray-900">
        <!-- Conte√∫do injetado pelo JavaScript -->
    </div>

    <!-- Modal para Puzzles -->
    <div id="modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="modal-content" class="modal-content bg-white text-gray-800 p-8 rounded-2xl shadow-2xl max-w-2xl w-full transform scale-95">
            <!-- Conte√∫do do Puzzle -->
        </div>
    </div>
    
    <script>
        const gameState = {
            timer: 900, // 15 minutos
            timerId: null,
            puzzlesSolved: {
                drawer: false,       // 1. Gaveta
                computerLogin: false,// 2. Login do PC
                jigsaw: false,       // 3. Quebra-cabe√ßa
                recycleBin: false,   // 4. Lixeira (NOVO)
                logicGrid: false,    // 5. Relat√≥rio de L√≥gica
                plotTwist: false,    // 6. Chamada de v√≠deo
                panel: false,        // 7. Painel El√©trico
                recorder: false,     // 8. Gravador
                safe: false          // 9. Cofre
            },
            noteRead: false, // Flag to check if the locked note was read
            selectedJigsawPiece: null,
            panelSequence: [],
            plotTwistShown: false
        };

        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startButton = document.getElementById('start-button');
        
        const timerDisplay = document.getElementById('timer');
        const messageDisplay = document.getElementById('message-display');

        const objDrawer = document.getElementById('obj-drawer');
        const objComputer = document.getElementById('obj-computer');
        const objSafe = document.getElementById('obj-safe');
        const objBook = document.getElementById('obj-book');
        const objPanel = document.getElementById('obj-panel');
        const objRecorder = document.getElementById('obj-recorder');
        const objCalendar = document.getElementById('obj-calendar'); 
        const objBoard = document.getElementById('obj-board');       
        
        const modalOverlay = document.getElementById('modal-overlay');
        const modalContent = document.getElementById('modal-content');
        
        let synth, successSound, errorSound, clickSound, staticNoise, alarmSound, drawerOpenSound, computerStartSound;

        // --- Fun√ß√µes de Som ---
        function setupAudio() {
            clickSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 } }).toDestination();
            successSound = new Tone.Synth({ oscillator: { type: 'triangle' } }).toDestination();
            errorSound = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();
            staticNoise = new Tone.Noise("white").toDestination();
            staticNoise.volume.value = -20;
            alarmSound = new Tone.Synth({ oscillator: {type: "fatsawtooth", count: 3, spread: 30}, envelope: {attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.4}}).toDestination();
            const drawerFilter = new Tone.AutoFilter("8n").toDestination().start();
            const drawerNoise = new Tone.Noise("pink").connect(drawerFilter);
            drawerNoise.volume.value = -15;
            drawerOpenSound = () => { drawerNoise.start().stop("+0.3"); };
            const startupSynth = new Tone.Synth().toDestination();
            computerStartSound = () => {
                const now = Tone.now();
                startupSynth.triggerAttackRelease("C4", "8n", now);
                startupSynth.triggerAttackRelease("G4", "8n", now + 0.2);
                startupSynth.triggerAttackRelease("C5", "4n", now + 0.4);
            };
        }

        // --- Fun√ß√µes do Jogo ---
        function startGame() {
            setupAudio();
            Tone.start();

            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            gameScreen.classList.add('flex');
            gameState.timerId = setInterval(updateTimer, 1000);
            updateObjectStates();
            showMessage("A sala est√° trancada. Preciso encontrar o diploma... A gaveta parece ser o primeiro passo.", 5000);
        }

        function updateTimer() {
            gameState.timer--;
            const minutes = Math.floor(gameState.timer / 60);
            const seconds = gameState.timer % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (gameState.timer <= 0) {
                endGame(false);
            }
            if (gameState.timer < 60 && !timerDisplay.classList.contains('animate-pulse')) {
                timerDisplay.classList.add('animate-pulse');
            }
        }
        
        function showMessage(text, duration = 3000) {
            messageDisplay.textContent = text;
            messageDisplay.classList.remove('opacity-0');
            setTimeout(() => {
                messageDisplay.classList.add('opacity-0');
            }, duration);
        }

        function endGame(isWin) {
            clearInterval(gameState.timerId);
            gameScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            endScreen.classList.add('flex');

            if (isWin) {
                successSound.triggerAttackRelease("C5", "0.5");
                 endScreen.innerHTML = `
                    <div class="w-full max-w-4xl">
                        <div class="video-container mb-4 rounded-lg overflow-hidden shadow-2xl">
                             <iframe src="https://player.vimeo.com/video/1092890946?h=f9b2da8306&autoplay=1&loop=1&title=0&byline=0&portrait=0" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                        </div>
                        <h1 class="text-5xl font-bold mb-4 text-green-500">Diploma Recuperado!</h1>
                        <p class="text-xl mb-8">Parab√©ns! Voc√™ provou seu conhecimento e est√° pronto para a formatura!</p>
                        <button onclick="window.location.reload()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition-transform duration-200 transform hover:scale-105">Jogar Novamente</button>
                    </div>
                `;
            } else {
                errorSound.triggerAttackRelease("C3", "0.5");
                 endScreen.innerHTML = `
                    <h1 class="text-5xl font-bold mb-4 text-red-500">Tempo Esgotado!</h1>
                    <p class="text-xl mb-8">A cerim√¥nia de formatura come√ßou sem voc√™... Estude mais o Regimento e tente novamente.</p>
                    <button onclick="window.location.reload()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition-transform duration-200 transform hover:scale-105">Jogar Novamente</button>
                `;
            }
        }

        function updateObjectStates() {
            objComputer.classList.toggle('opacity-50', !gameState.puzzlesSolved.drawer);
            objComputer.classList.toggle('cursor-not-allowed', !gameState.puzzlesSolved.drawer);

            objPanel.classList.toggle('opacity-50', !gameState.puzzlesSolved.logicGrid);
            objPanel.classList.toggle('cursor-not-allowed', !gameState.puzzlesSolved.logicGrid);

            objRecorder.classList.toggle('opacity-50', !gameState.puzzlesSolved.panel);
            objRecorder.classList.toggle('cursor-not-allowed', !gameState.puzzlesSolved.panel);
            
            objSafe.classList.toggle('opacity-50', !gameState.puzzlesSolved.recorder);
            objSafe.classList.toggle('cursor-not-allowed', !gameState.puzzlesSolved.recorder);
        }

        // --- Fun√ß√µes de Puzzle e Modais ---
        function showModal(content, isPuzzle=true) {
            const closeButton = isPuzzle ? `<button onclick="closeModal()" class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button>` : '';
            modalContent.innerHTML = closeButton + content;
            modalOverlay.classList.remove('hidden');
            setTimeout(() => {
                modalOverlay.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }
        
        function closeModal() {
            modalOverlay.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modalOverlay.classList.add('hidden');
            }, 300);
        }
        
        function showRegimento() {
            clickSound.triggerAttackRelease("F4", "0.1");
            const regimentoText = `<h2 class="text-2xl font-bold mb-4 text-[#005594]">Regimento Educacional - Consulta</h2><div class="regimento-content mono"><p><strong>Art. 16.</strong> A <strong>Secretaria Escolar</strong> √© o setor respons√°vel pelos processos de recebimento, confer√™ncia, expedi√ß√£o e arquivo da documenta√ß√£o relativa aos registros escolares dos estudantes.</p><hr class="my-2"><p><strong>Art. 26. Dos Deveres dos Estudantes:</strong><br>...IX - utilizar os ambientes e recursos tecnol√≥gicos de aprendizagem em estrito alinhamento com a Pol√≠tica de Seguran√ßa da Informa√ß√£o (PSI);<br>...X - preservar o <strong>patrim√¥nio</strong> da institui√ß√£o, bem como o patrim√¥nio de institui√ß√µes parceiras, respondendo por qualquer dano ou preju√≠zo que venha a causar.</p><hr class="my-2"><p><strong>Art. 28. Das Medidas Reparadoras:</strong> ...sujeito √†s seguintes medidas reparadoras:<br>I - <strong>advert√™ncia</strong>;<br>II - <strong>suspens√£o</strong>;<br>III - <strong>desligamento</strong>.</p><hr class="my-2"><p><strong>Art. 55.</strong> A <strong>frequ√™ncia m√≠nima de 75%</strong> √© obrigat√≥ria para aprova√ß√£o...</p><hr class="my-2"><p><strong>Art. 78.</strong> O <strong>diploma</strong> √© o documento emitido aos estudantes aprovados...</p></div><button onclick="closeModal()" class="mt-4 bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Fechar</button>`;
            showModal(regimentoText, false);
        }
        
        // Puzzle 1: Gaveta
        function puzzleDrawer() {
            clickSound.triggerAttackRelease("C4", "0.1");
            const content = `<h2 class="text-2xl font-bold mb-4 text-[#005594]">Gaveta com Cadeado</h2><p class="mb-4">"A chave para sua aprova√ß√£o √© a chave para esta gaveta. Qual a frequ√™ncia m√≠nima obrigat√≥ria (Art. 55)?"</p><div class="flex justify-center gap-2 mb-4"><input type="number" id="code1" class="input-code text-center border-2 border-gray-300 rounded-lg" maxlength="1" onkeyup="moveToNext(this, 'code2')"><input type="number" id="code2" class="input-code text-center border-2 border-gray-300 rounded-lg" maxlength="1" onkeyup="moveToNext(this, 'code3')"><input type="number" id="code3" class="input-code text-center border-2 border-gray-300 rounded-lg" maxlength="1"></div><div class="flex gap-4 justify-center"><button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Voltar</button><button onclick="checkDrawerCode()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg font-semibold">Abrir</button></div>`;
            showModal(content);
        }

        function checkDrawerCode() {
            const code = document.getElementById('code1').value + document.getElementById('code2').value + document.getElementById('code3').value;
            if (code === '075') {
                drawerOpenSound();
                gameState.puzzlesSolved.drawer = true;
                closeModal();
                showMessage("Correto! Dentro da gaveta, encontrei uma nota: 'Senha do computador: setor que cuida da sua vida escolar.'", 6000);
                updateObjectStates();
            } else {
                errorSound.triggerAttackRelease("A2", "0.2");
                showMessage("C√≥digo incorreto. Preciso consultar o Regimento sobre a frequ√™ncia.", 3000);
            }
        }
        window.moveToNext = function(current, nextFieldID) {
            if (current.value.length >= current.maxLength) { document.getElementById(nextFieldID).focus(); }
        }

        // Puzzle 2: Computador Login
        function puzzleComputer() {
             clickSound.triggerAttackRelease("D4", "0.1");
             const content = `<h2 class="text-2xl font-bold mb-4 text-[#005594]">Login do Sistema</h2><p class="mb-4">A nota da gaveta dizia: "...a senha √© o nome do setor que cuida da sua vida escolar." (Art. 16)</p><input type="text" id="password-input" class="w-full p-2 border border-gray-400 rounded-md mb-4 text-center uppercase" autocomplete="off"><div class="flex gap-4 justify-center"><button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Voltar</button><button onclick="checkComputerPassword()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg font-semibold">Entrar</button></div>`;
             showModal(content);
        }

        function checkComputerPassword() {
            const pass = document.getElementById('password-input').value.toUpperCase().replace(/\s+/g, '');
            if (pass === 'SECRETARIAESCOLAR') {
                computerStartSound();
                gameState.puzzlesSolved.computerLogin = true;
                closeModal();
                showMessage("Acesso concedido! O que temos aqui na √Årea de Trabalho?", 5000);
                updateObjectStates();
                showComputerDesktop();
            } else {
                errorSound.triggerAttackRelease("A2", "0.2");
                showMessage("Senha incorreta. Qual setor cuida dos documentos escolares?", 3000);
            }
        }

        // Computador Desktop
        function showComputerDesktop() {
            const reportFileUnlocked = gameState.puzzlesSolved.jigsaw;
            const reportFileClasses = reportFileUnlocked ? "cursor-pointer" : "opacity-50 cursor-not-allowed";
            const reportFileOnClick = reportFileUnlocked ? "onclick='showReportFile()'" : "onclick='showMessage(\"Arquivo protegido. Preciso de uma senha. Talvez o esquema da chave ajude.\", 3000)'";
            
            // L√≥gica da Lixeira corrigida
            let recycleBinClasses = "opacity-50 cursor-not-allowed";
            let recycleBinOnClick = "onclick='showMessage(\"N√£o parece ter nada de importante aqui... por enquanto.\", 3000)'";

            if (gameState.noteRead && !gameState.puzzlesSolved.recycleBin) {
                recycleBinClasses = "cursor-pointer";
                recycleBinOnClick = "onclick='puzzleRecycleBin()'";
            } else if (gameState.puzzlesSolved.recycleBin) {
                recycleBinClasses = "cursor-pointer";
                recycleBinOnClick = "onclick='puzzleLogicGrid()'";
            }

            const content = `
                <h2 class="text-2xl font-bold mb-4 text-[#005594]">√Årea de Trabalho</h2>
                <div class="grid grid-cols-3 gap-8 text-center">
                    <div class="interactive-object flex flex-col items-center" onclick="puzzleJigsaw()">
                        <span class="text-5xl">üîë</span>
                        <span>esquema_chave.png</span>
                    </div>
                    <div class="flex flex-col items-center ${reportFileClasses}" ${reportFileOnClick}>
                        <span class="text-5xl">üìÑ</span>
                        <span>nota_bloqueada.txt</span>
                    </div>
                    <div class="interactive-object flex flex-col items-center ${recycleBinClasses}" ${recycleBinOnClick}>
                        <span class="text-5xl">üóëÔ∏è</span>
                        <span>Lixeira</span>
                    </div>
                </div>
                <button onclick="closeModal()" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Sair do Computador</button>`;
            showModal(content);
        }
        
        // Puzzle 3: Jigsaw (Chave)
        function puzzleJigsaw() {
            clickSound.triggerAttackRelease("E4", "0.1");
            const pieces = Array.from({length: 9}, (_, i) => i).sort(() => Math.random() - 0.5);
            const content = `<h2 class="text-2xl font-bold mb-4 text-[#005594]">Esquema da Chave</h2><p class="mb-4">Monte o esquema para revelar a senha da nota.</p><div id="jigsaw-puzzle" class="jigsaw-grid">${pieces.map(p => `<div class="jigsaw-piece" data-pos="${p}" onclick="selectJigsawPiece(this)" style="background-position: ${-(p % 3) * 100}px ${-Math.floor(p / 3) * 100}px;"></div>`).join('')}</div><div class="flex gap-4 justify-center mt-4"><button onclick="showComputerDesktop()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Voltar</button></div>`;
            showModal(content);
        }

        function selectJigsawPiece(piece) {
            if (!gameState.selectedJigsawPiece) {
                piece.classList.add('selected');
                gameState.selectedJigsawPiece = piece;
            } else {
                const piece1 = gameState.selectedJigsawPiece;
                const tempPos = piece1.style.backgroundPosition;
                const tempDataPos = piece1.dataset.pos;
                piece1.style.backgroundPosition = piece.style.backgroundPosition;
                piece1.dataset.pos = piece.dataset.pos;
                piece.style.backgroundPosition = tempPos;
                piece.dataset.pos = tempDataPos;
                piece1.classList.remove('selected');
                gameState.selectedJigsawPiece = null;
                checkJigsawSolution();
            }
        }

        function checkJigsawSolution() {
            const pieces = document.querySelectorAll('#jigsaw-puzzle .jigsaw-piece');
            const isSolved = Array.from(pieces).every((p, i) => parseInt(p.dataset.pos) === i);
            if (isSolved) {
                successSound.triggerAttackRelease("B5", "0.2");
                gameState.puzzlesSolved.jigsaw = true;
                showMessage("Esquema montado! A imagem forma a palavra 'CONHECIMENTO'. Deve ser a senha da nota.", 5000);
                setTimeout(showComputerDesktop, 1000);
            }
        }
        
        // Arquivo de Nota
        function showReportFile() {
             clickSound.triggerAttackRelease("F4", "0.1");
            const content = `
                <h2 class="text-2xl font-bold mb-4 text-[#005594]">Nota Protegida</h2>
                <p class="mb-4">Digite a senha revelada pelo esquema da chave.</p>
                <input type="text" id="report-password" class="w-full p-2 border border-gray-400 rounded-md mb-4 text-center uppercase" autocomplete="off">
                <div class="flex gap-4 justify-center">
                    <button onclick="showComputerDesktop()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Voltar</button>
                    <button onclick="checkReportPassword()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg font-semibold">Desbloquear</button>
                </div>`;
            showModal(content);
        }

        function checkReportPassword() {
            const pass = document.getElementById('report-password').value.toUpperCase();
            if (pass === 'CONHECIMENTO') {
                successSound.triggerAttackRelease("F5", "0.2");
                gameState.noteRead = true; // Habilita a intera√ß√£o com a lixeira
                const noteContent = `
                    <h2 class="text-2xl font-bold mb-4">Nota Desbloqueada</h2>
                    <p class="text-lg text-left p-4 bg-gray-100 rounded">"O relat√≥rio do incidente foi considerado muito sens√≠vel e movido para a Lixeira para seguran√ßa. A senha de recupera√ß√£o √© o ano em que tudo come√ßou."</p>
                    <button onclick="showComputerDesktop()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg font-semibold">Voltar para Desktop</button>
                `;
                showModal(noteContent);
            } else {
                errorSound.triggerAttackRelease("A2", "0.2");
                showMessage("Senha incorreta.", 2000);
            }
        }

        // Puzzle da Lixeira
        function puzzleRecycleBin() {
            clickSound.triggerAttackRelease("A3", "0.1");
            const content = `
                <h2 class="text-2xl font-bold mb-4 text-[#005594]">Lixeira Protegida</h2>
                <p class="mb-4">A nota dizia: "...a senha de recupera√ß√£o √© o ano em que tudo come√ßou."</p>
                <input type="number" id="recycle-password" class="w-full p-2 border border-gray-400 rounded-md mb-4 text-center" autocomplete="off">
                <div class="flex gap-4 justify-center">
                    <button onclick="showComputerDesktop()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Voltar</button>
                    <button onclick="checkRecycleBinPassword()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg font-semibold">Restaurar Arquivos</button>
                </div>`;
            showModal(content);
        }

        function checkRecycleBinPassword() {
            const pass = document.getElementById('recycle-password').value;
            if (pass === '1946') {
                successSound.triggerAttackRelease("G5", "0.2");
                gameState.puzzlesSolved.recycleBin = true;
                showMessage("Senha correta! O arquivo 'relatorio.docx' foi restaurado. Agora posso abri-lo.", 5000);
                puzzleLogicGrid();
            } else {
                errorSound.triggerAttackRelease("A2", "0.2");
                showMessage("Senha incorreta. Onde posso encontrar uma data importante?", 3000);
            }
        }

        // Puzzle de L√≥gica
        function puzzleLogicGrid() {
            const content = `<h2 class="text-2xl font-bold mb-4 text-[#005594]">Relat√≥rio de Incidente</h2><p class="mb-4">Use o Regimento para preencher o relat√≥rio.</p><div class="text-left space-y-2 mb-4 p-4 bg-gray-100 rounded"><p><strong>Pistas:</strong></p><p>1. Ana praticou um ato que N√ÉO resultou em suspens√£o.</p><p>2. A pessoa que danificou o patrim√¥nio (Art. 26, X) foi desligada.</p><p>3. Beto n√£o praticou cyberbullying.</p></div><table class="w-full text-center border-collapse"><thead><tr><th class="border p-2">Aluno</th><th class="border p-2">Infra√ß√£o</th><th class="border p-2">Medida</th></tr></thead><tbody><tr><td class="border p-2">Ana</td><td class="border p-2"><select id="ana-infraction" class="w-full"><option>Cyberbullying</option><option>Dano ao Patrim√¥nio</option></select></td><td class="border p-2"><select id="ana-medida" class="w-full"><option>Advert√™ncia</option><option>Suspens√£o</option><option>Desligamento</option></select></td></tr><tr><td class="border p-2">Beto</td><td class="border p-2"><select id="beto-infraction" class="w-full"><option>Cyberbullying</option><option>Dano ao Patrim√¥nio</option></select></td><td class="border p-2"><select id="beto-medida" class="w-full"><option>Advert√™ncia</option><option>Suspens√£o</option><option>Desligamento</option></select></td></tr></tbody></table><div class="flex gap-4 justify-center mt-4"><button onclick="showComputerDesktop()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Voltar</button><button onclick="checkLogicGrid()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg font-semibold">Verificar</button></div>`;
            showModal(content);
        }

        function checkLogicGrid() {
            const anaInfraction = document.getElementById('ana-infraction').value;
            const anaMedida = document.getElementById('ana-medida').value;
            const betoInfraction = document.getElementById('beto-infraction').value;
            const betoMedida = document.getElementById('beto-medida').value;
            if (anaInfraction === 'Cyberbullying' && anaMedida === 'Advert√™ncia' && betoInfraction === 'Dano ao Patrim√¥nio' && betoMedida === 'Desligamento') {
                successSound.triggerAttackRelease("C6", "0.2");
                gameState.puzzlesSolved.logicGrid = true;
                closeModal();
                setTimeout(showPlotTwist, 1000);
            } else {
                errorSound.triggerAttackRelease("A2", "0.2");
                showMessage("Dados incorretos. Preciso reler as pistas e o Regimento.", 3000);
            }
        }

        // Plot Twist
        function showPlotTwist() {
            if(gameState.plotTwistShown) {
                showMessage("O painel el√©trico da sala acendeu.", 3000);
                updateObjectStates();
                return;
            }
             const content = `<h2 class="text-2xl font-bold mb-4 text-yellow-500">Chamada de V√≠deo Recebida...</h2><div class="video-container mb-4"><iframe src="https://player.vimeo.com/video/1092796983?h=329987718c&autoplay=1&loop=1&autopause=0" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div><p id="call-text" class="mb-4 min-h-[48px]">Um colega desesperado aparece na tela pedindo ajuda...</p><div id="call-buttons" class="flex gap-4 justify-center mt-6"><button onclick="handlePlotTwistChoice('refuse')" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg font-semibold">Recusar Ajuda</button><button onclick="handlePlotTwistChoice('help')" class="bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-lg font-semibold">Ajudar o Colega</button></div>`;
            showModal(content, false);
        }


        function handlePlotTwistChoice(choice) {
            gameState.plotTwistShown = true;
            if (choice === 'help') {
                alarmSound.triggerAttackRelease("A4", "0.5");
                gameState.timer = Math.floor(gameState.timer / 2);
                closeModal();
                showMessage("VIOLA√á√ÉO! Tentativa de fraude detectada. Tempo reduzido pela metade!", 8000);
            } else { 
                successSound.triggerAttackRelease("E6", "0.3");
                gameState.timer += 180; // +3 minutos
                closeModal();
                showMessage("CONDUTA √âTICA VERIFICADA! Recompensa: +3 minutos.", 8000);
            }
            setTimeout(() => showMessage("O painel el√©trico da sala acendeu.", 8000), 8000);
            updateObjectStates();
        }
        
        // Puzzle: Painel El√©trico
        function puzzlePanel() {
            clickSound.triggerAttackRelease("C4", "0.1");
            gameState.panelSequence = [];
            const content = `<h2 class="text-2xl font-bold mb-4 text-[#005594]">Painel El√©trico</h2><p class="mb-4">Acione os disjuntores na ordem correta das Medidas Reparadoras (Art. 28).</p><div class="flex justify-center gap-4 mb-4"><button id="btn-susp" onclick="pressPanelButton('suspensao')" class="p-4 rounded bg-gray-400">Suspens√£o</button><button id="btn-desl" onclick="pressPanelButton('desligamento')" class="p-4 rounded bg-gray-400">Desligamento</button><button id="btn-adv" onclick="pressPanelButton('advertencia')" class="p-4 rounded bg-gray-400">Advert√™ncia</button></div><div id="panel-display" class="h-8 bg-gray-200 rounded text-black flex items-center justify-center mono"></div><div class="flex gap-4 justify-center mt-4"><button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Voltar</button></div>`;
            showModal(content);
        }
        
        function pressPanelButton(btn) {
            clickSound.triggerAttackRelease("E5", "0.05");
            gameState.panelSequence.push(btn);
            document.getElementById('panel-display').textContent = gameState.panelSequence.join(' -> ').toUpperCase();
            if (gameState.panelSequence.length === 3) {
                if (JSON.stringify(gameState.panelSequence) === JSON.stringify(['advertencia', 'suspensao', 'desligamento'])) {
                    successSound.triggerAttackRelease("C6", "0.2");
                    gameState.puzzlesSolved.panel = true;
                    closeModal();
                    showMessage("Energia restaurada! O gravador sobre a mesa come√ßou a emitir um ru√≠do.", 5000);
                    updateObjectStates();
                } else {
                    errorSound.triggerAttackRelease("A2", "0.2");
                    showMessage("Sequ√™ncia incorreta. O painel reiniciou.", 3000);
                    setTimeout(puzzlePanel, 1000);
                }
            }
        }
        
        // Puzzle: Gravador de √Åudio
        function puzzleRecorder() {
            clickSound.triggerAttackRelease("F4", "0.1");
            staticNoise.start().stop("+0.5");
             const content = `<h2 class="text-2xl font-bold mb-4 text-[#005594]">Gravador Antigo</h2><p class="mb-4">O gravador toca: <span class="mono text-red-500">"...pr3s3rv4r o p4tr1m√¥n1o..."</span>. Qual √© a palavra-chave final (Art. 26, X)?</p><input type="text" id="audio-password" class="w-full p-2 border border-gray-400 rounded-md mb-4 text-center uppercase" autocomplete="off"><div class="flex gap-4 justify-center"><button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Voltar</button><button onclick="checkAudioPassword()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg font-semibold">Verificar</button></div>`;
             showModal(content);
        }

        function checkAudioPassword() {
            const pass = document.getElementById('audio-password').value.toUpperCase();
            if(pass === 'PATRIMONIO') {
                successSound.triggerAttackRelease("D6", "0.2");
                gameState.puzzlesSolved.recorder = true;
                closeModal();
                showMessage("Palavra decifrada! Uma luz pisca no cofre os n√∫meros: '2' '6' '7' e '8'.", 6000);
                updateObjectStates();
            } else {
                errorSound.triggerAttackRelease("A2", "0.2");
                showMessage("N√£o √© essa a palavra. O que devemos preservar?", 3000);
            }
        }

        // Puzzle: Cofre Final
        function puzzleSafe() {
            clickSound.triggerAttackRelease("G4", "0.1");
            const content = `<h2 class="text-2xl font-bold mb-4 text-[#005594]">O Cofre Final</h2><p class="mb-4">O c√≥digo √© a jun√ß√£o de dois artigos. A luz pisca '2','6','7','8'. Qual a ordem correta, pensando no percurso de um aluno (Regras e depois o Pr√™mio)?</p><input type="text" id="safe-password" class="w-full p-3 border border-gray-400 rounded-md mb-4 text-center mono text-2xl" autocomplete="off" placeholder="XXXX"><div class="flex gap-4 justify-center"><button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Voltar</button><button onclick="checkSafePassword()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-lg font-semibold">Abrir Cofre</button></div>`;
            showModal(content);
        }

        function checkSafePassword() {
            const pass = document.getElementById('safe-password').value;
            if (pass === '2678') { // Art. 26 (Regras) + Art. 78 (Pr√™mio)
                gameState.puzzlesSolved.safe = true;
                closeModal();
                endGame(true);
            } else {
                 errorSound.triggerAttackRelease("A2", "0.2");
                 showMessage("C√≥digo errado. Preciso verificar os artigos no Regimento.", 3000);
            }
        }
        
        // --- Fun√ß√µes para Novos Objetos ---
        function showCalendar() {
            clickSound.triggerAttackRelease("G4", "0.1");
            const content = `
                <h2 class="text-2xl font-bold mb-4 text-[#005594]">Calend√°rio de Parede</h2>
                <div class="p-4 bg-gray-100 rounded-lg text-center">
                    <p class="text-lg">Um calend√°rio antigo...</p>
                    <p class="text-6xl font-bold my-4 text-red-600 border-4 border-red-500 rounded-full inline-block p-4">1946</p>
                    <p class="text-lg mono">Anota√ß√£o: "O in√≠cio de tudo."</p>
                </div>
                <button onclick="closeModal()" class="mt-4 bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Fechar</button>
            `;
            showModal(content, false);
        }

        function showBoard() {
             clickSound.triggerAttackRelease("A4", "0.1");
            const content = `
                 <h2 class="text-2xl font-bold mb-4 text-[#005594]">Quadro de Avisos</h2>
                 <div class="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
                    <p class="font-bold">Vem ai o Casa Aberta!!!:</p>
                    <p>Abrimos as portas de nossas 63 unidades para um dia repleto de atividades inspiradoras, que v√£o desde workshops e palestras at√© atendimentos e oficinas. Participe!.</p>
                 </div>
                 <div class="p-4 mt-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700">
                    <p class="font-bold">Minuto Regimento:</p>
                    <p>Respeitar as diferen√ßas √© um compromisso de todos! O regimento garante um ambiente escolar livre de discrimina√ß√£o e preconceito, promovendo o respeito √†s identidades e culturas de cada aluno. 
                    </p>
                 </div>
                  <button onclick="closeModal()" class="mt-4 bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold">Fechar</button>
            `;
            showModal(content, false);
        }


        // --- Event Listeners ---
        startButton.addEventListener('click', startGame);
        
        objDrawer.addEventListener('click', () => {
            if (!gameState.puzzlesSolved.drawer) puzzleDrawer();
            else showMessage("Eu j√° abri esta gaveta.", 2000);
        });
        objComputer.addEventListener('click', () => {
            if (!gameState.puzzlesSolved.drawer) {
                 showMessage("Preciso de uma pista para ligar isso. Talvez na gaveta?", 3000);
                 return;
            }
            if (!gameState.puzzlesSolved.computerLogin) {
                puzzleComputer();
                return;
            }
            if (gameState.puzzlesSolved.computerLogin && !gameState.puzzlesSolved.logicGrid) {
                showComputerDesktop();
                return;
            }
             if (gameState.puzzlesSolved.logicGrid && !gameState.plotTwistShown) {
                showPlotTwist();
                return;
            }
            showMessage("Acho que j√° fiz tudo que precisava no computador.", 3000);
        });
        objPanel.addEventListener('click', () => {
            if(gameState.puzzlesSolved.logicGrid && !gameState.puzzlesSolved.panel) puzzlePanel();
            else if (!gameState.puzzlesSolved.logicGrid) showMessage("O painel est√° sem energia. Preciso resolver os enigmas do computador primeiro.", 4000);
            else showMessage("A energia j√° foi restaurada.", 2000);
        });
        objRecorder.addEventListener('click', () => {
             if(gameState.puzzlesSolved.panel && !gameState.puzzlesSolved.recorder) puzzleRecorder();
            else if (!gameState.puzzlesSolved.panel) showMessage("O gravador n√£o liga. Falta energia?", 3000);
            else showMessage("J√° ouvi a mensagem deste gravador.", 2000);
        });
        objSafe.addEventListener('click', () => {
            if (gameState.puzzlesSolved.recorder && !gameState.puzzlesSolved.safe) puzzleSafe();
            else if (!gameState.puzzlesSolved.recorder) showMessage("Este cofre parece ser o desafio final. Preciso resolver os outros enigmas primeiro.", 4000);
        });
        objBook.addEventListener('click', showRegimento);
        objCalendar.addEventListener('click', showCalendar); 
        objBoard.addEventListener('click', showBoard);       

    </script>
</body>
</html>
